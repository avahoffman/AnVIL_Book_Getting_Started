# (PART\*) Getting Started {-}

# Publishing Workspaces to AnVIL with AnVILPublish

## Overview

This guide will show you how to publish a Workspace on AnVIL using RStudio. Publishing Workspaces programmatically makes it easier to incorporate version control (e.g., using [Git](https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control)) and ensures that all of your notebook files end up in the Workspace. 

### Before you start

1. You need to set up Billing. This includes your Google Billing Account and Terra Billing Project. Take note of your Terra Billing Project name.

1. Create your first Workspace. A first Workspace is needed to launch RStudio, but after that, all Workspaces can be made programmatically from within Workspaces.

1. Launch RStudio using the Community-Maintained RStudio Environment. This requires you to be familiar with computing environments.

## Installation

This guide is based on the [AnVILPublish vignette](https://bioconductor.org/packages/release/bioc/vignettes/AnVILPublish/inst/doc/AnVILPublishIntro.html), which can serve as an additional reference.

### AnVIL and AnVILPublish

Install `AnVIL` and `AnVILPublish`. **Make sure to load the development version of `AnVILPublish`.** Don't worry about loading it for now.

```{r install_bioc, eval = FALSE}
# Development version
BiocManager::install("Bioconductor/AnVILPublish")
```

### Notedown

Navigate to the RStudio Terminal and install [`notedown`](https://github.com/aaren/notedown) using `pip3`. This module converts markdown documents into `.ipynb` notebooks.

```{bash notedown_1, eval=FALSE}
pip3 install notedown
```

RStudio doesn't automatically know where to look for `notedown`. Add the `notedown` installation to your RStudio PATH:

```{r notedown_2, eval = FALSE}
# Add to PATH
existing_path <- Sys.getenv("PATH")
notedown_path <- "/home/rstudio/.local/bin"
Sys.setenv(PATH = paste(existing_path, notedown_path, sep = ":"))
```

Confirm that `notedown` is ready to use:

```{r notedown_3}
# Confirm notedown is accessible
system2("notedown", "--version")
```

## Workspace content

You need a folder with content to get started. This will be the basic structure of your files:

```
Workspace-folder
|-DESCRIPTION
|-LICENSE.md
|-NAMESPACE
|-README.md
|-vignettes
  |-Notebook_1.Rmd
```

You have a couple of options to add content: 

* Locate a repository in GitHub with content you want to copy. It must contain a `DESCRIPTION` file, `NAMESPACE` file, and a `vignettes` directory with at least one `.Rmd` file.   

* If you want to start from scratch, the easiest way to do this is to first clone this [skeleton repository](https://github.com/avahoffman/AnVILPublish-skeleton). You'll notice it contains a `DESCRIPTION` file, `NAMESPACE` file, and a `vignettes` directory with a `.Rmd` file.  
    ```{bash gitclone, eval = FALSE}
git clone https://github.com/avahoffman/AnVILPublish-skeleton
    ```  

* *NOTE: If you only have a few files, you don't need the `vignettes` directory, but you must make sure the `.Rmd` file(s) are in the same directory as the `DESCRIPTION` and `NAMESPACE` files.*

### `DESCRIPTION` file

Edit the information in `DESCRIPTION` but keep the structure the same. 

1. `Package:` argument: This "package name" must match the name of the folder containing the `DESCRIPTION` and other files.

```{r, echo=FALSE, fig.alt="The Workspace Package name in the DESCRIPTION file is highlighted."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdeb937803b_0_0")
```

2. `Title:` argument: This will become the name of your Workspace on the dashboard.

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is visible in the DESCRIPTION file."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gcf1264c749_0_140")
```

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is visible as subtext in the list of Workspaces."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_2")
```

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is most visible from the Workspace Dashboard tab."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_7")
```

3. `Authors@R:` argument: Your author information and information.
4. `Description:` argument: A several-sentence description of the project.

### `NAMESPACE` file

Do not edit the `NAMESPACE` file.

### `README.md` file

Use the `README.md` file to add more in depth details to your Workspace Dashboard page.

### `.Rmd` file(s)

The `.Rmd` file contains your content. You can make many `.Rmd` files.

## Running AnVILPublish

Before you start, you should note the Terra Billing Project. If you are **updating** a Workspace, take note of the Workspace name. If you are **creating** a Workspace, pick a new meaningful name for the Workspace.

```{r, echo=FALSE, fig.alt="The Workspace name is visible from your list of Workspaces."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_12")
```

```{r, echo=FALSE, fig.alt="The Workspace name is visible in the Workspace URL."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdeb937803b_0_8")
```

### Creating a new Workspace

Run `AnVILPublish::as_workspace()`. Replace `<billing-project>` with the appropriate Billing Project of your choosing above. Replace `<My-Workspace>` with the Workspace name of your choosing above.

```{r publish_1, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/home/rstudio/AnVILPublish-skeleton", # directory containing DESCRIPTION file
  namespace = "<billing-project>", # Billing project
  name = "<My-Workspace>", # Actual Workspace name
  create = TRUE, # Makes a *new* Workspace
  use_readme = TRUE # Use README file for additional Dashboard Description
)
```

### Updating a Workspace

Run `AnVILPublish::as_workspace()`. Replace `<billing-project>` with the appropriate Billing Project. Replace `<My-Workspace>` with the Workspace name. Note that the Workspace name cannot be changed after the Workspace is created, so make sure this matches your existing Workspace exactly!

```{r publish_2, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/home/rstudio/AnVILPublish-skeleton", # directory containing DESCRIPTION file
  namespace = "<billing-project>", # Billing project
  name = "<My-Workspace>", # Actual Workspace name
  update = TRUE, # Updates the Workspace with your changes
  use_readme = TRUE # Use README file for additional Dashboard Description
)
```

## Committing your changes

If this is a brand new repository for you, don't forget to `add` files, `commit` changes, and `push` those changes to your GitHub repository.

1. Initialize your `.Rproj`.

    - Click on File > "New Project..."  
    ```{r, echo=FALSE, fig.alt="A screenshot of the RStudio File dropdown menu on AnVIL. The listing 'New Project' is highlighted."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_17")
    ```  
    - Select "Existing Directory".  
    - Select the AnVIL directory you've been working in.  
    
1. [`add`](https://git-scm.com/docs/git-add/en) and [`commit`](https://git-scm.com/docs/git-commit) your changes.  
  
1. Login to [github.com](https://github.com/) and create a new repository.  

    - Note the name of your new repository.  
    - Don't add a `README.md`, `.gitignore`, or license.  
  
1. In the RStudio terminal, rename the AnVIL repository's current 'origin' to 'upstream'.  
  
    ```{bash rename_origin, eval = FALSE}
git remote rename origin upstream
    ```

1. Give the local repository an 'origin' that points to your repository on github.com. Replace `<your-username>` with your GitHub username and `<your-new-repo>` with the name of the new repository you just created.  

    ```{bash add_origin, eval = FALSE}
git remote add origin https://github.com/<your-username>/<your-new-repo>.git
    ```

1. Push the AnVIL repository to your remote repository on github.com.

    ```{bash push_orign, eval = FALSE}
git push origin main
    ```
    - You will be prompted for your GitHub credentials. Remember that you might need to use a GitHub Personal Token instead of your password!