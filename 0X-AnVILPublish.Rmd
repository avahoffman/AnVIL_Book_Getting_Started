# (PART\*) Getting Started {-}

# Publishing Workspaces to AnVIL with AnVILPublish

## Installation

This guide is based heavily on the AnVILPublish vignette [here](https://bioconductor.org/packages/release/bioc/vignettes/AnVILPublish/inst/doc/AnVILPublishIntro.html).

### AnVIL and AnVILPublish

Install `AnVIL` and `AnVILPublish`. **Make sure to load the development version of `AnVILPublish`.** Don't worry about loading them for now.

```{r install_bioc, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

# Development version
BiocManager::install("Bioconductor/AnVIL")

# Development version
BiocManager::install("Bioconductor/AnVILPublish")
```

### Google Cloud SDK

Install Google Cloud (gcloud) SDK. This allows you to authenticate your access to AnVIL. This step can also be done separately from R/RStudio [here](https://cloud.google.com/sdk/docs/quickstart).

```{r install_gcloud, eval = FALSE}
if (!"cloudml" %in% rownames(installed.packages()))
    BiocManager::install("cloudml")
```

### Notedown

Install `notedown` using `pip` following instructions [here](https://github.com/aaren/notedown) (i.e., `pip install notedown`). This module converts markdown documents into `.ipynb` notebooks.

```{r notedown_1}
# Confirm notedown is accessible
system2("notedown", "--version")
```

This can be non-trivial because RStudio might not know where to look for `notedown`. Usually this can accomplished by editing your `PATH` (see help for [Mac](https://www.architectryan.com/2012/10/02/add-to-the-path-on-mac-os-x-mountain-lion/) and [Windows](https://www.architectryan.com/2018/03/17/add-to-the-path-on-windows-10/)) to include the directories where python modules are installed (e.g., `/Users/username/opt/anaconda3/bin/`). If you don't have permissions to do so, you can also specify where RStudio should look to find `notedown` manually by:

- Determining where `notedown` is installed by running `which notedown` in your Terminal or PowerShell
- Copying the parent directory where `notedown` is installed
- Adding to the RStudio PATH using `Sys.setenv()`.
- For example:

```{r notedown_2, eval = FALSE}
# Not run
existing_path <- Sys.getenv("PATH")
notedown_path <- "/Users/username/opt/anaconda3/bin" # This varies based on your operating system
Sys.setenv(PATH = paste(existing_path, notedown_path, sep = ":"))

# Confirm notedown is accessible
system2("notedown", "--version")
```

## Google Cloud credentials setup

Prompt the gcloud SDK setup process. This will take you to the Terminal tab of Rstudio. You'll be asked for your AnVIL credentials (Google account) in a browser pop-up. Finally, you'll be asked what billing project to use for setup. This does not need to be done every time, just whenever you need to change the billing project.

```{r cloudml, eval = FALSE}
cloudml::gcloud_install(update = TRUE)
```

Use `AnVIL::gcloud_exists()` to determine whether the gcloud configuration has been completed (`[1] True`)

```{r gcloudcheck}
# Is gcloud set up?
AnVIL::gcloud_exists()
```

Use `AnVIL::gcloud_account()` to confirm the correct email is being used. Use `AnVIL::gcloud_project()` to determine the default billing project.

```{r gclouddetails}
# Which account is being used?
AnVIL::gcloud_account()
AnVIL::gcloud_project()
```

## Workspace content

You need a folder on your local machine to get started. The easiest way to do this is to first clone this [skeleton repository](https://github.com/avahoffman/AnVILPublish-skeleton). You'll notice it contains a `DESCRIPTION` file, `NAMESPACE` file, and a `vignettes` directory with a `.Rmd` file. 

```
|-DESCRIPTION
|-LICENSE.md
|-NAMESPACE
|-README.md
|-vignettes
  |-Notebook_1.Rmd
```

If you only have a few files, you don't need the `vignettes` directory, but you must make sure the `.Rmd` file(s) are in the same directory as the `DESCRIPTION` and `NAMESPACE` files.

### `DESCRIPTION` file

Edit the information in `DESCRIPTION` but keep the structure the same. 

1. `Package:` argument: This "package name" must match the name of the folder containing the `DESCRIPTION` and other files.
2. `Title:` argument: This will become the name of your Workspace on the dashboard.

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is visible in the DESCRIPTION file."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gcf1264c749_0_140")
```

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is visible as subtext in the list of Workspaces."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_2")
```

```{r, echo=FALSE, fig.alt="The Workspace Dashboard title is most visible from the Workspace Dashboard tab."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_7")
```

3. `Authors@R:` argument: Your author information and information
4. `Description:` argument: A several-sentence description of the project.

### `NAMESPACE` file

Do not edit the `NAMESPACE` file.

### `README.md` file

Use the `README.md` file to add more in depth details to your Workspace Dashboard page.

### `.Rmd` file(s)

The `.Rmd` file contains your content. You can make many `.Rmd` files.

## Running AnVILPublish

You will need a few things:

- The directory containing the `DESCRIPTION` file
- The appropriate billing project
- The Workspace name that will appear in the link 

```{r, echo=FALSE, fig.alt="The Workspace name is visible from your list of Workspaces."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_12")
```

```{r, echo=FALSE, fig.alt="The Workspace name is visible in the Workspace URL."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1tgDv3RvflT5wChx2pFNkcLQqcW5EehQ82JRdo6uB-us/edit#slide=id.gdd7e85f9a2_0_17")
```

Run `AnVILPublish::as_workspace`:

```{r publish, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/path/to/AnVILPublish-skeleton", # directory containing DESCRIPTION file
  namespace = "billing-project",           # Billing project
  name = "My-Workspace",                   # Actual Workspace name
  create = TRUE,                           # Use `update = TRUE` to overwrite
  use_readme = TRUE     # Use README file for additional Dashboard Description
)
```