# Instructors

This chapter is targeted towards people who are teaching a course or workshop on AnVIL. You will find here:

<br> <!-- Capital letter makes part of below content indented which doesn't look good.. can remove the <br> if more text is added above -->
<br>

- **Overview** -- Design philosophy and goals for this guide - is this a good fit for your class?  What should you know before you start?
- **Account Setup** -- Step-by-step instructions to create your first accounts on AnVIL and create your first class Workspace
- **Developing Content** -- Additional tools to help you customize your class Workspace
- **Class Setup** -- Step-by-step instructions to help you add students into a class on AnVIL
- **Class Ending** -- Best practices for finishing your course cleanly and minimizing costs
- **Student Account Setup** -- Step-by-step account set up for students using AnVIL in your class

::: {.fyi}
Please click on the subsection headers in the left hand 
navigation bar (e.g., 2.2, 4.2) a second time to expand the 
table of contents and enable the `scroll_highlight` feature 
([see more](https://jhudatascience.org/AnVIL_Book_Getting_Started/introduction.html#activate-scroll_highlight-feature)).
:::

<!------------------------------------------>

## Overview

### Goals for This Guide

```{r, echo=FALSE, fig.alt="List of goals for this guide: (1) get your accounts, (2) set up billing, (3) create your first Workspace, (4) develop content, and (5) set up classes with students."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.ge21c626cf0_0_5")
```

### Design Philosophy

This guide provides an opinionated walkthrough on how to set up AnVIL for your class.  These step-by-step instructions take instructors that are completely new to the AnVIL through account setup to the point where you can feel comfortable hosting a class from start-to-finish on AnVIL. Following the recommendations in this guide will help you minimize expenses, develop content programmatically, track individual student expenses, and stop billing expenses from accruing once the class is complete. In support of these goals we have made the following design decisions:

1. ACCOUNT SETUP

a. Sign up for a personal Google Cloud Account, where you can get started by claiming [$300 free Google credits](https://cloud.google.com/free/docs/gcp-free-tier/#free-trial).

2. CONTENT DEVELOPING

a. Include version control and visibility of course content by using GitHub. This will allow you to add content programmatically, keep track of changes, and share your content with others outside of AnVIL.

3. CLASS SETUP

a. Create a separate Google Billing Account for each class. This will allow you to easily shut down expenses at the end of the class.
b. Choose one funding source per class (for example, the [STRIDES](#strides-funding) Program).
b. Create separate Terra Billing Projects for each student. This will allow you to monitor billing expenses closely and work with students to build best computing practices.

### Before You Start

- You will need a **credit card or bank account** to activate your free trial and get started. Don't worry! **You won't be billed until you explicitly turn on automatic billing**, but payment information is needed for verification purposes.
- Before setting up billing yourself, you may want to check with your institutional procurement office and see if they have a preferred account set-up method with Google (such as a third party reseller or an existing account).

<!-- Checklist -->

<!------------------------------------------>

## Account Setup {#account-setup-instructors}

::: {.fyi}
Please click on the subsection headers in the left hand 
navigation bar (e.g., 2.2, 4.2) a second time to expand the 
table of contents and enable the `scroll_highlight` feature 
([see more](https://jhudatascience.org/AnVIL_Book_Getting_Started/introduction.html#activate-scroll_highlight-feature)).
:::

### Overview of Account Setup

### Step 1: Create a Google Account

### Step 2: Set Up Google Billing

### Step 3: Add Terra to Google Billing Account

### Step 4: Create a Terra Billing Project

### Step 5: Set Up Alerts

### Step 6: Create First Workspace

### Wrap-Up

<!------------------------------------------>

## Developing Content

### Overview of Developing Content

This section will show you how to publish a Workspace on AnVIL using RStudio. Publishing Workspaces programmatically makes it easier to incorporate version control (e.g., using Git) and ensures that all of your notebook files end up in the Workspace.

Much of the information in this section comes from the [AnVILPublish vignette](https://bioconductor.org/packages/release/bioc/vignettes/AnVILPublish/inst/doc/AnVILPublishIntro.html), which can serve as an additional reference.

#### Before You Start

1. You need to set up [Billing](#account-setup-instructors). This includes your Google Billing Account and Terra Billing Project. Take note of your Terra Billing Project name.

1. Create your first Workspace. A first Workspace is needed to launch RStudio, but after that, all Workspaces can be made programmatically from within other Workspaces.

1. Launch RStudio using the Community-Maintained RStudio Environment. This requires you to be familiar with [RStudio on AnVIL](#starting-rstudio).

### Set Up AnVILPublish on AnVIL

#### Install AnVILPublish

Install `AnVIL` and `AnVILPublish`. **Make sure to load the development version of `AnVILPublish`.** Don't worry about loading it for now.

```{r install_anvil, eval = FALSE}
BiocManager::install("AnVIL")
# Development version
BiocManager::install("Bioconductor/AnVILPublish")
```

#### Install Notedown

Next, navigate to the RStudio Terminal and install [`notedown`](https://github.com/aaren/notedown) using `pip3`. This module converts markdown documents into `.ipynb` notebooks.

```{bash notedown_1, eval=FALSE}
pip3 install notedown
```

RStudio doesn't automatically know where to look for `notedown`. Add the `notedown` installation to your RStudio PATH:

```{r notedown_2, eval = FALSE}
# Add to PATH
existing_path <- Sys.getenv("PATH")
notedown_path <- "/home/rstudio/.local/bin"
Sys.setenv(PATH = paste(existing_path, notedown_path, sep = ":"))
```

Confirm that `notedown` is ready to use:

```{r notedown_3}
# Confirm notedown is accessible
system2("notedown", "--version")
```

You should see the version number printed to the console:

```{r, echo=FALSE, fig.alt="Output on the RStudio console. You should see the version number printed if notedown has been installed correctly."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.gdb96a00840_0_80")
```

### Create Workspace Structure

#### Identify Your Repository

You need a folder with content to get started. In the next step, this will be the basic structure of your files:

```
AnVILPublish-skeleton
|-DESCRIPTION
|-LICENSE.md
|-NAMESPACE
|-README.md
|-vignettes
  |-Notebook_1.Rmd
```

"AnVILPublish-skeleton" is the name of the folder containing all of your information. The folder must contain a `DESCRIPTION` file, `NAMESPACE` file, and a `vignettes` directory with at least one `.Rmd` file. As you develop content, you might end up with many `.Rmd` notebooks inside the `vignettes` directory. We will practice with a basic set of files that are already set up for you on [GitHub](https://github.com/).

First, you will want to clone the [skeleton repository](https://github.com/avahoffman/AnVILPublish-skeleton). You'll notice it contains a `DESCRIPTION` file, `NAMESPACE` file, and a `vignettes` directory with an `.Rmd` file.

```{bash gitclone, eval = FALSE}
git clone https://github.com/avahoffman/AnVILPublish-skeleton
```  

#### Changing the `DESCRIPTION` File

Edit the information in `DESCRIPTION` but keep the structure the same.

1. `Package:` argument: This "package name" must match the name of the folder containing the `DESCRIPTION` and other files. In this case, it should be "AnVILPublish-skeleton".

```{r, echo=FALSE, fig.alt="File screenshot showing the `Package:` argument is AnVILPublish-skeleton"}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.geb84bbba9a_2_8")
```

2. `Title:` argument: This will become the header for your Workspace's Dashboard.

```{r, echo=FALSE, fig.alt="File screenshot showing the `Title:` argument is 'Workspace title on the Dashboard'"}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.geb84bbba9a_2_14")
```

3. `Authors@R:` argument: Your author information and roles.

4. `Description:` argument: A several-sentence description of the project.

#### Changing Other Files

Do not edit the `NAMESPACE` file. The `README.md` file and `.Rmd` file(s) will be discussed in more detail in [Update Dashboard].

#### Create the Workspace

Use the `AnVILPublish::as_workspace()` function. Replace `<billing-project>` with the appropriate Terra Billing Project of your choosing. Replace `<My-Workspace>` with the Workspace name of your choosing.

```{r publish_1, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/home/rstudio/AnVILPublish-skeleton",  # directory containing DESCRIPTION file
  namespace = "<billing-project>",     # Billing project
  name = "<My-Workspace>",             # Actual Workspace name
  create = TRUE                        # Makes a *new* Workspace
)
```

You will see output in the console as the function converts the `.Rmd` to `.md`. You might get some warning messages, but make sure that the Workspace was created without error:

```{r, echo=FALSE, fig.alt="Code to create a new Workspace produces knitr output in the console."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.geb84bbba9a_2_20")
```

```{r, echo=FALSE, fig.alt="Code to create a new Workspace produces knitr output in the console. You should not see any errors in the output."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.geb84bbba9a_2_26")
```

You should now see this new Workspace at [https://anvil.terra.bio/#workspaces](https://anvil.terra.bio/#workspaces).

```{r, echo=FALSE, fig.alt="After running AnVILPublish, you should see the newly created Workspace in https://anvil.terra.bio/#workspaces."}
leanbuild::include_slide("https://docs.google.com/presentation/d/1HHWg47Tg6miv_K7GNB6ZDTx-4Jc5IMl7APfFtD1Rqag/edit#slide=id.geb84bbba9a_2_32")
```

### Update Dashboard

Edit the `README.md` file to add more details to your Workspace Dashboard page. You will use the same function you used to create the Workspace as to update it, with a small change. Instead of `create = TRUE` you’ll now see an argument `update = TRUE`. Be very careful to use the correct Workspace name here, so you don’t accidentally overwrite the wrong Workspace.

```{r publish_2, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/home/rstudio/AnVILPublish-skeleton",  # directory containing DESCRIPTION file
  namespace = "<billing-project>",    # Billing project
  name = "<My-Workspace>",            # Actual Workspace name
  update = TRUE,                      # Updates the Workspace with your changes
  use_readme = TRUE                   # Use README file for Dashboard Description
)
```

You can also click the pencil button next to “ABOUT THE WORKSPACE” to edit the Dashboard manually, but these changes won’t show up later in GitHub. They will also be overwritten by other AnVILPublish updates.

### Post Jupyter Notebook

The `.Rmd` file contains your content. You can make many `.Rmd` files. These will get turned into `.ipynb` Jupyter Notebooks when you update using AnVILPublish. After you make changes to your `.Rmd` files, update the Workspace by running:

```{r publish_3, eval = FALSE}
AnVILPublish::as_workspace(
  path = "/home/rstudio/AnVILPublish-skeleton",  # directory containing DESCRIPTION file
  namespace = "<billing-project>",    # Billing project
  name = "<My-Workspace>",            # Actual Workspace name
  update = TRUE,                      # Updates the Workspace with your changes
  use_readme = TRUE                   # Use README file for Dashboard Description
)
```

Note that this is the same code used to update the Workspace Dashboard. You can use this exact code to update your workspace any time you save changes in RStudio!

### Push Changes to GitHub

Hosting the code behind your course on GitHub will ensure that it is reproducible, easy to update, and robust to any tweaks you make. After cloning the skeleton repository, you will need to make a few changes to ensure your content ends up associated with your GitHub account. This means you own it and can make/save changes!

Briefly, you should:

1. Create a new repository on [GitHub](https://github.com/new). Don't add a `README.md`, `.gitignore`, or license.

1. Return to RStudio on AnVIL and Initialize your `.Rproj`.

1. `add` and `commit` your changes on AnVIL.  

1. [Rename and add](https://git-scm.com/docs/git-remote) a new origin that points to the new repository you just created.

1. `push` your changes. Remember that you will need to use a [GitHub Personal Token](https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token) instead of your password.

Git can be challenging. Please reach out to our community network at [help.anvilproject.org](https://help.anvilproject.org/) for help.

## Class Setup

### Identify Funding

#### NHGRI STRIDES {#strides-funding}

Through the [STRIDES](https://datascience.nih.gov/strides) program, NHGRI makes funding available to new users of the AnVIL, in collaboration with the [NIH Office of Data Science Strategy](https://datascience.nih.gov/about/odss). NHGRI currently supports the [AnVIL Cloud Credits Program (AC2)](https://anvilproject.org/news/2021/04/12/announcing-anvil-cloud-cost-credits-program) and will have a second round of funding available in fall of 2021.

### Set Up Billing Project

### Collect Student IDs

### Set Up Permissions

#### Add students as “Member” 

<!-- to Terra Group (so don’t have to type every ID) -->

#### Add Group as “Reader” 

<!-- to Instructor Workspace (to allow clone of this workspace) -->

#### Add Group as “User” 

<!-- Roles on Billing Project (allow to clone any workspace) -->

<!------------------------------------------>

## Class Ending

### Notify Students

### Disable Billing

<!------------------------------------------>

## Student Account Setup

### Create a Google Account

### Set Up Terra

### Provide ID to Instructor

<!------------------------------------------>

## Class Checklist

This checklist can serve as a reminder of the overall suggested steps to make a new class on AnVIL. You might find yourself changing these steps slightly as you become more familiar with AnVIL.

**Billing**

- Obtain funding through the [STRIDES](https://datascience.nih.gov/strides) program (optional)
- Request students make AnVIL IDs (Google IDs) 
- Collect AnVIL IDs (Google IDs) from students
- Create Google Billing Account for your class
- Create Terra Billing Projects for your students
- Deactivate Billing Projects

**Resources**

- Create a Workspace for your class
- Notify Terra of your course dates and times
- Direct students to the Workspace

**Permissions**

- Set up Groups to manage permissions

| AnVIL Group | Class Workspace | Terra Billing Projects*|
|:------------|:----------------|:-----------------------|
| Instructor  | Owner           | Owner                  |
| TAs         | Writer          | Owner                  |
| Students    | Reader          | User                   |

\* You should have n + 1 Terra Billing Projects: one for each student and one shared by instructors.
